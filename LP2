#include <iostream>
#include <fstream>
#include <vector>
#include <string>
#include <sstream>
using namespace std;

struct MNTEntry {
    string name;
    int mdtIndex;
};

int main() {
    ifstream input("inp.txt");
    ofstream mntFile("mnt.txt");
    ofstream mdtFile("mdt.txt");
    ofstream interFile("intermediate.txt");
    ofstream expandedFile("expanded.txt");

    vector<MNTEntry> mnt;
    vector<string> mdt;
    string line;

    // ----- PASS 1 -----
    while (getline(input, line)) {
        stringstream ss(line);
        string first;
        ss >> first;

        if (first == "MACRO") {
            getline(input, line); // macro header
            mdt.push_back(line);
            stringstream hdr(line);
            string macroName; hdr >> macroName;

            MNTEntry entry = { macroName, (int)mdt.size() - 1 };
            mnt.push_back(entry);

            while (getline(input, line)) {
                mdt.push_back(line);
                if (line == "MEND") break;
            }
        } else {
            interFile << line << endl; // write to intermediate file
        }
    }

    // ----- Write MNT and MDT -----
    for (int i = 0; i < mnt.size(); i++)
        mntFile << i+1 << "\t" << mnt[i].name << "\t" << mnt[i].mdtIndex << endl;
    for (int i = 0; i < mdt.size(); i++)
        mdtFile << i+1 << "\t" << mdt[i] << endl;

    input.close();
    interFile.close();

    // ----- PASS 2 -----
    ifstream inter("intermediate.txt");
    string word;
    while (getline(inter, line)) {
        stringstream ss(line);
        ss >> word;
        bool isMacro = false;

        for (auto m : mnt) {
            if (word == m.name) {
                isMacro = true;
                for (int i = m.mdtIndex + 1; i < mdt.size(); i++) {
                    if (mdt[i] == "MEND") break;
                    expandedFile << mdt[i] << endl;
                }
                break;
            }
        }

        if (!isMacro)
            expandedFile << line << endl;
    }

    cout << "\n Macro Expansion Completed! Check 'expanded.txt'.\n";
    return 0;
}

MACRO
COPY &SRC,&DEST
MOV AREG,&SRC
MOV &DEST,AREG
MEND

MACRO
CLEAR &REG
MOV &REG,='0'
MEND

START
COPY DATA1,DATA2
CLEAR AREG
END
